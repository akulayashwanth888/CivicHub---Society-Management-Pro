<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CivicHub | Society Management</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      scroll-behavior: smooth;
    }
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>

<body class="bg-slate-50 text-slate-900">

  <div id="root"></div>

  <!-- LOGIN (NO DESIGN CHANGE, SIMPLE ADDITION) -->
  <h2>Login</h2>
  <input id="email" placeholder="Email">
  <br><br>
  <input id="password" type="password" placeholder="Password">
  <br><br>
  <button onclick="login()">Login</button>
  <button onclick="logout()">Logout</button>

  <hr>

  <!-- RAISE COMPLAINT -->
  <h2>Raise a Complaint</h2>
  <textarea id="issue" placeholder="Enter your complaint"></textarea>
  <br><br>
  <button onclick="submitComplaint()">Submit Complaint</button>

  <hr>

  <!-- VIEW COMPLAINTS -->
  <h2>My / All Complaints</h2>
  <button onclick="loadComplaints()">View Complaints</button>

  <div id="complaints"></div>

<script>
  const BASE_URL = "https://civichub-society-management-pro.onrender.com";

  function getToken() {
    return localStorage.getItem("token");
  }

  function getRole() {
    const token = getToken();
    if (!token) return null;
    return JSON.parse(atob(token.split(".")[1])).role;
  }

  // LOGIN
  function login() {
  localStorage.clear(); // remove old junk

  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  fetch(`${BASE_URL}/api/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  })
  .then(res => res.json())
  .then(data => {
    console.log("LOGIN RESPONSE:", data); // DEBUG LINE

    if (data.token) {
      localStorage.setItem("token", data.token); // ðŸ”¥ THIS WAS MISSING
      alert("Login successful");
    } else {
      alert(data.message || "Login failed");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Login error");
  });
}


  // LOGOUT
  function logout() {
    localStorage.clear();
    alert("Logged out");
  }

  // SUBMIT COMPLAINT (RESIDENT)
  function submitComplaint() {
    fetch(`${BASE_URL}/api/complaints`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": getToken()
      },
      body: JSON.stringify({
        issue: document.getElementById("issue").value
      })
    })
    .then(res => res.json())
    .then(data => alert(data.message));
  }

  function loadComplaints() {
  fetch(
    "https://civichub-society-management-pro.onrender.com/api/complaints/all",
    {
      headers: {
        Authorization: localStorage.getItem("token")
      }
    }
  )
  .then(res => res.json())
  .then(data => {
    let html = "";
    data.forEach(c => {
      html += `
        <div class="ticket-row">
          <div class="subject">
            <strong>${c.issue}</strong>
          </div>
          <div class="status">
            <span class="badge ${c.status.toLowerCase()}">
              ${c.status}
            </span>
          </div>
          <div class="date">
            ${new Date(c.createdAt || Date.now()).toLocaleDateString()}
          </div>
        </div>
      `;
    });
    document.getElementById("complaints").innerHTML = html;
  })
  .catch(err => {
    console.error(err);
    alert("Error loading complaints");
  });
}


</script>

<script type="module" src="/index.tsx"></script>
</body>
</html>
